const {pool}=require('./util/db'); const {json,unauthorized,forbidden}=require('./util/http'); const {getAuth,requireRole}=require('./util/guard'); exports.handler=async(e)=>{ const a=getAuth(e); if(!a) return unauthorized(); if(!requireRole(a,['admin'])) return forbidden(); const c=await pool.connect(); try{ const r=await c.query('SELECT id, name, email, role, created_at FROM users ORDER BY created_at DESC LIMIT 500'); return json(200,{users:r.rows}); } finally{ c.release(); } };