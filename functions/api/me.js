const {pool}=require('./util/db'); const {json,unauthorized}=require('./util/http'); const {getAuth}=require('./util/guard'); exports.handler=async(e)=>{ const a=getAuth(e); if(!a) return unauthorized(); const c=await pool.connect(); try{ const me=await c.query('SELECT id, name, email, role FROM users WHERE id=$1',[a.id]); const owned=await c.query('SELECT c.id, c.title, c.slug, c.price, c.level, c.hours, c.image FROM purchases p JOIN courses c ON c.id=p.course_id WHERE p.user_id=$1 ORDER BY p.created_at DESC',[a.id]); return json(200,{user:me.rows[0],owned:owned.rows}); } finally{ c.release(); } };