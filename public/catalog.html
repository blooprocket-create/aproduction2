<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>All Courses — Novus Academy</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <header class="header">
    <div class="container nav">
      <a class="brand" href="index.html"><div class="logo"></div><span>Novus Academy</span></a>
      <nav class="flex">
        <a href="catalog.html">Courses</a>
        <a id="accountLink" href="account.html" style="display:none">Account</a>
        <a id="loginLink" href="login.html">Login</a>
        <a href="admin.html" class="btn secondary" data-role="admin-link">Control Panel</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h1>All Courses</h1>
      <p class="sub">Learn to build and launch with AI—clean, practical curriculum. Create an account to purchase and unlock access.</p>
      <div id="catalogGrid" class="grid"></div>
    </section>
  </main>

  <footer class="footer">
    <div class="container flex" style="justify-content:space-between">
      <div>© <span id="year"></span> Novus Academy</div>
      <div class="flex" style="gap:16px">
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
  <script src="auth.js"></script>
  <script>
    // nav auth toggle
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        const u = JSON.parse(localStorage.getItem('novus:user')||'null');
        const role = u?.role||null;
        document.querySelectorAll('[data-role="admin-link"]').forEach(el=>{
          if(!(role==='admin'||role==='editor')) el.style.display='none';
        });
        const loginLink = document.getElementById('loginLink');
        const accountLink = document.getElementById('accountLink');
        if(u){
          if(accountLink) accountLink.style.display='';
          if(loginLink){
            loginLink.textContent = `Logout (${u.name||'Account'})`;
            loginLink.href = '#';
            loginLink.onclick = (e)=>{ e.preventDefault(); localStorage.removeItem('novus:token'); localStorage.removeItem('novus:user'); location.reload(); };
          }
        } else {
          if(accountLink) accountLink.style.display='none';
          if(loginLink){ loginLink.textContent='Login'; loginLink.href='login.html'; loginLink.onclick=null; }
        }
      }catch(e){}
    });

    // helpers
    function money(n){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n||0); }
    function authHeader(){
      const t = localStorage.getItem('novus:token'); return t? { Authorization: 'Bearer ' + t } : {};
    }
    const API = {
      async _parseJSON(res){ const text = await res.text(); try { return JSON.parse(text); } catch { throw new Error(`API returned non-JSON (status ${res.status}). First bytes: ${text.slice(0,100)}`); } },
      async get(path, auth=false){ const res = await fetch(`/api/${path}`, { headers: { ...(auth?authHeader():{}) } }); return this._parseJSON(res); },
      async post(path, data, auth=false){ const res = await fetch(`/api/${path}`, { method:'POST', headers: { 'Content-Type':'application/json', ...(auth?authHeader():{}) }, body: JSON.stringify(data||{}) }); return this._parseJSON(res); }
    };

    async function getOwnedIds(){
      const t = localStorage.getItem('novus:token');
      if(!t) return new Set();
      const me = await API.get('me', true).catch(()=>null);
      if(me?.owned) return new Set(me.owned.map(c=>c.id));
      return new Set();
    }

    (async function(){
      const { courses=[] } = await API.get('courses-list').catch(()=>({courses:[]}));
      const ownedIds = await getOwnedIds();
      const grid=document.getElementById('catalogGrid'); grid.innerHTML='';

      if(courses.length===0){ grid.innerHTML='<p class="sub">No courses yet.</p>'; return; }

      courses.forEach(c=>{
        const owned = ownedIds.has(c.id);
        const el=document.createElement('div'); el.className='card';
        el.innerHTML=`<div style="aspect-ratio:16/9;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:url('${c.image||'assets/course.png'}') center/cover no-repeat"></div>
          <h3>${c.title}</h3><div class="meta">${c.level||''} • ${c.hours||0} hrs</div>
          <p class="sub">${c.description||''}</p>
          <div class="flex" style="justify-content:space-between;margin-top:10px">
            <div class="price">${money(c.price)}</div>
            ${owned ? `<button class="btn" disabled>Owned</button>` : `<button class="btn" data-buy="${c.id}">Buy</button>`}
          </div>`;
        grid.appendChild(el);
      });

      grid.querySelectorAll('[data-buy]').forEach(btn=>btn.addEventListener('click', async (e)=>{
        const id=e.currentTarget.getAttribute('data-buy');
        const t = localStorage.getItem('novus:token');
        if(!t){ if(confirm('You need an account to buy. Create one now?')) location.href='register.html?next=account.html'; return; }
        const out = await API.post('purchase', {courseId:id}, true);
        if(out.error){ alert(out.error); return; }
        alert('Access granted! Visit My Courses.');
        location.href='account.html'; // ← fixed redirect
      }));
    })();
  </script>
</body>
</html>
