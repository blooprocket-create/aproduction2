
function money(n){return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n||0)}function requireRole(r){const u=currentUser();if(!u){location.href='login.html?next='+encodeURIComponent(location.pathname);return!1}if(r.length&&!r.includes(u.role)){alert('You do not have access.');location.href='index.html';return!1}return!0}(async function(){if(!requireRole(['admin','editor']))return;const $$=s=>document.querySelector(s);let editingId=null;async function refreshCourses(){const {courses=[]}=await API.get('courses-list',!0);const tbody=document.querySelector('#courseTable tbody');tbody.innerHTML='';courses.forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td><b>${c.title}</b><div class="meta">${(c.description||'').slice(0,80)}...</div></td><td>${money(c.price)}</td><td>${c.hours||0}</td><td>${c.level||''}</td><td>${c.published?'Yes':'No'}</td><td>${c.sales||0}</td><td class="flex"><button class="btn ghost" data-edit="${c.id}">Edit</button></td>`;tbody.appendChild(tr)});tbody.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-edit');const data=(window._lastCourses||[]).find(x=>x.id===id);editingId=data.id;$$('#cTitle').value=data.title||'';$$('#cPrice').value=data.price||0;$$('#cHours').value=data.hours||0;$$('#cLevel').value=data.level||'';$$('#cImage').value=data.image||'';$$('#cDesc').value=data.description||'';$$('#cPub').checked=!!data.published;document.getElementById('addCourse').style.display='none';let save=document.getElementById('saveCourse');if(!save){save=document.createElement('button');save.id='saveCourse';save.className='btn';save.textContent='Save changes';document.getElementById('courseFormActions').appendChild(save);save.addEventListener('click',onSave)}else save.style.display='';window.scrollTo({top:0,behavior:'smooth'})}));document.getElementById('salesTotals').innerHTML=(function(){const t=courses.reduce((a,c)=>{a.count+=(c.sales||0);a.revenue+=(c.sales||0)*(c.price||0);return a},{count:0,revenue:0});return `<h3>${t.count} sales</h3><p>Total revenue: ${money(t.revenue)}</p>`})();window._lastCourses=courses}async function onSave(){if(!editingId)return;const payload={id:editingId,title:$$('#cTitle').value.trim(),price:parseFloat($$('#cPrice').value||'0'),hours:parseFloat($$('#cHours').value||'0'),level:$$('#cLevel').value.trim(),image:$$('#cImage').value.trim(),description:$$('#cDesc').value.trim(),published:$$('#cPub').checked};const out=await API.post('courses-update',payload,!0);if(out.error){alert(out.error);return}editingId=null;document.getElementById('addCourse').style.display='';const btn=document.getElementById('saveCourse');if(btn)btn.style.display='none';['#cTitle','#cPrice','#cHours','#cLevel','#cImage','#cDesc'].forEach(s=>{const el=$$(s);if(el)el.value='' });$$('#cPub').checked=!0;await refreshCourses()}document.getElementById('addCourse')?.addEventListener('click',async()=>{const title=$$('#cTitle').value.trim(),price=parseFloat($$('#cPrice').value||'0'),hours=parseFloat($$('#cHours').value||'0'),level=$$('#cLevel').value.trim(),image=$$('#cImage').value.trim(),description=$$('#cDesc').value.trim(),published=$$('#cPub').checked;if(!title||!description){alert('Title and Description required.');return}const out=await API.post('courses-create',{title,price,hours,level,image,description,published},!0);if(out.error){alert(out.error);return}['#cTitle','#cPrice','#cHours','#cLevel','#cImage','#cDesc'].forEach(s=>{const el=$$(s);if(el)el.value='' });$$('#cPub').checked=!0;await refreshCourses()});async function refreshUsers(){const out=await API.get('users-list',!0).catch(()=>({users:[]}));const tbody=document.querySelector('#userTable tbody');if(!tbody)return;tbody.innerHTML='';(out.users||[]).forEach(u=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td>${new Date(u.created_at).toLocaleString()}</td>`;tbody.appendChild(tr)})}document.getElementById('addUser')?.addEventListener('click',async()=>{const name=document.getElementById('uName').value.trim();const email=document.getElementById('uEmail').value.trim();const role=document.getElementById('uRole').value.trim()||'customer';const pw=(document.getElementById('uPassword')?.value||'').trim()||'';if(!name||!email){alert('Name and Email required.');return}const out=await API.post('users-create',{name,email,role,password:pw},!0);if(out.error){alert(out.error);return}['uName','uEmail','uRole','uPassword'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='' });await refreshUsers()});await refreshCourses();await refreshUsers()})();