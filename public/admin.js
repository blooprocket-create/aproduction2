function money(n,c='USD'){return new Intl.NumberFormat('en-US',{style:'currency',currency:c}).format(n||0)}function requireRole(r){const u=currentUser();if(!u){location.href='login.html?next='+encodeURIComponent(location.pathname);return!1}return!(Array.isArray(r)&&r.length&&!r.includes(u.role))||(alert('You do not have access.'),location.href='index.html',!1)}(async function(){if(!requireRole(['admin','editor'])) return;const $$=s=>document.querySelector(s);let editingId=null;async function refreshCourses(){const {courses=[]}=await API.get('courses-list',!0);const tbody=document.querySelector('#courseTable tbody');tbody.innerHTML='';courses.forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td><b>${c.title}</b><div class="meta">${(c.description||'').slice(0,80)}...</div></td><td>${money(c.price)}</td><td>${c.hours||0}</td><td>${c.level||''}</td><td>${c.published?'Yes':'No'}</td><td>${c.sales||0}</td><td class="flex"><button class="btn ghost" data-edit="${c.id}">Edit</button></td>`;tbody.appendChild(tr)});tbody.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-edit');const {courses}=window._lastCourses||{courses:[]};const cc=(courses||[]).find(x=>x.id===id);editingId=cc.id;$$('#cTitle').value=cc.title||'';$$('#cPrice').value=cc.price||0;$$('#cHours').value=cc.hours||0;$$('#cLevel').value=cc.level||'';$$('#cImage').value=cc.image||'';$$('#cDesc').value=cc.description||'';$$('#cPub').checked=!!cc.published;document.getElementById('addCourse').style.display='none';let saveBtn=document.getElementById('saveCourse');if(!saveBtn){saveBtn=document.createElement('button');saveBtn.id='saveCourse';saveBtn.className='btn';saveBtn.textContent='Save changes';document.getElementById('courseFormActions').appendChild(saveBtn);saveBtn.addEventListener('click',onSave)}else saveBtn.style.display='';window.scrollTo({top:0,behavior:'smooth'})}));const totals=courses.reduce((a,c)=>(a.count+=(c.sales||0),a.revenue+=(c.sales||0)*(c.price||0),a),{count:0,revenue:0});document.getElementById('salesTotals').innerHTML=`<h3>${totals.count} sales</h3><p>Total revenue: ${money(totals.revenue)}</p>`;window._lastCourses={courses}}async function onSave(){if(!editingId) return;const payload={id:editingId,title:$$('#cTitle').value.trim(),price:parseFloat($$('#cPrice').value||'0'),hours:parseFloat($$('#cHours').value||'0'),level:$$('#cLevel').value.trim(),image:$$('#cImage').value.trim(),description:$$('#cDesc').value.trim(),published:$$('#cPub').checked};const out=await API.post('courses-update',payload,!0);if(out.error){alert(out.error);return}editingId=null;document.getElementById('addCourse').style.display='';const btn=document.getElementById('saveCourse');if(btn) btn.style.display='none';['#cTitle','#cPrice','#cHours','#cLevel','#cImage','#cDesc'].forEach(s=>{const el=$$(s);if(el) el.value='' });$$('#cPub').checked=!0;await refreshCourses()}document.getElementById('addCourse')?.addEventListener('click',async()=>{const title=$$('#cTitle').value.trim(),price=parseFloat($$('#cPrice').value||'0'),hours=parseFloat($$('#cHours').value||'0'),level=$$('#cLevel').value.trim(),image=$$('#cImage').value.trim(),description=$$('#cDesc').value.trim(),published=$$('#cPub').checked;if(!title||!description){alert('Title and Description required.');return}const out=await API.post('courses-create',{title,price,hours,level,image,description,published},!0);if(out.error){alert(out.error);return}['#cTitle','#cPrice','#cHours','#cLevel','#cImage','#cDesc'].forEach(s=>{const el=$$(s);if(el) el.value='' });$$('#cPub').checked=!0;await refreshCourses()});async function refreshUsers(){const out=await API.get('users-list',!0).catch(()=>({users:[]}));const tbody=document.querySelector('#userTable tbody');if(!tbody) return;tbody.innerHTML='';(out.users||[]).forEach(u=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td>${new Date(u.created_at).toLocaleString()}</td>`;tbody.appendChild(tr)})}document.getElementById('addUser')?.addEventListener('click',async()=>{const name=document.getElementById('uName').value.trim();const email=document.getElementById('uEmail').value.trim();const role=document.getElementById('uRole').value.trim()||'customer';const pw=(document.getElementById('uPassword')?.value||'').trim()||'';if(!name||!email){alert('Name and Email required.');return}const out=await API.post('users-create',{name,email,role,password:pw},!0);if(out.error){alert(out.error);return}['uName','uEmail','uRole','uPassword'].forEach(id=>{const el=document.getElementById(id);if(el) el.value='' });await refreshUsers()});await refreshCourses();await refreshUsers()})();